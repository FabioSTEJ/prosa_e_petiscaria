{% extends "base_admin.html" %}

{% block content %}
<div class="container-admin">
    <div class="header-vendas">
        <h2>Hist√≥rico de Vendas üí∞</h2>
        <div class="card-resumo">
            <span>Faturamento Total:</span>
            <strong>R$ {{ "%.2f"|format(faturamento_total) }}</strong>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>Data/Hora</th>
                    <th>Mesa</th>
                    <th>Atendente</th>
                    <th>Total Pago</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody>
                {% for venda in vendas %}
                <tr>
                    <td>
                        {{ venda.data_fechamento.strftime('%d/%m/%Y') }}<br>
                        <small class="text-muted">{{ venda.data_fechamento.strftime('%H:%M') }}</small>
                    </td>
                    <td><strong>Mesa {{ venda.mesa_numero }}</strong></td>
                    <td>{{ venda.aberta_por_nome }}</td>
                    <td class="col-valor">R$ {{ "%.2f"|format(venda.valor_total) }}</td>
                    <td>
                        <button class="btn-action btn-edit" 
                                onclick="abrirDetalhesVenda('{{ venda.mesa_numero }}', '{{ venda.observacoes }}')" 
                                title="Ver Itens Consumidos">
                            üîç Ver Itens
                        </button>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5" style="text-align: center; padding: 20px;">
                        Nenhuma venda registrada at√© o momento.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div id="modalDetalhes" class="modal-venda">
    <div class="modal-venda-content">
        <div class="modal-venda-header">
            <h3 id="modalTitulo">Itens da Comanda</h3>
            <span class="close-modal" onclick="fecharModal()">&times;</span>
        </div>
        <div class="modal-venda-body">
            <p><strong>Produtos consumidos:</strong></p>
            <div id="modalCorpoItens" class="lista-itens-detalhe">
                </div>
        </div>
    </div>
</div>

<style>
    .header-vendas { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
    .card-resumo { background: #28a745; color: white; padding: 15px 30px; border-radius: 12px; }
    .col-valor { color: #28a745; font-weight: bold; }
    
    /* Estilos do Modal */
    .modal-venda { 
        display: none; 
        position: fixed; 
        z-index: 1000; 
        left: 0; top: 0; width: 100%; height: 100%; 
        background-color: rgba(0,0,0,0.5); 
    }
    .modal-venda-content { 
        background-color: #fff; 
        margin: 10% auto; 
        padding: 20px; 
        border-radius: 8px; 
        width: 400px; 
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .modal-venda-header { display: flex; justify-content: space-between; border-bottom: 1px solid #ddd; padding-bottom: 10px; }
    .close-modal { cursor: pointer; font-size: 24px; font-weight: bold; }
    .lista-itens-detalhe { background: #f9f9f9; padding: 15px; border-radius: 5px; margin-top: 10px; line-height: 1.6; }
</style>

<script>
function abrirDetalhesVenda(mesa, observacoes) {
    document.getElementById('modalTitulo').innerText = "Detalhes da Mesa " + mesa;
    
    // Se n√£o houver itens gravados, avisa o usu√°rio
    const textoItens = observacoes ? observacoes : "Nenhum item detalhado nesta venda antiga.";
    
    // Formata a string para que as v√≠rgulas virem quebras de linha para melhor leitura
    const itensFormatados = textoItens.split(',').join('<br> ‚Ä¢ ');
    document.getElementById('modalCorpoItens').innerHTML = "‚Ä¢ " + itensFormatados;
    
    document.getElementById('modalDetalhes').style.display = "block";
}

function fecharModal() {
    document.getElementById('modalDetalhes').style.display = "none";
}

// Fechar se clicar fora do modal
window.onclick = function(event) {
    if (event.target == document.getElementById('modalDetalhes')) {
        fecharModal();
    }
}
</script>
{% endblock %}